sudo: required

env:
  global:
    - IMAGE_NAME=bywater/koha-ncip-server
    - REGISTRY_USER=kylemhall
    # REGISTRY_PASS=...
    - secret: "dsfkjdf78ewr23rju32j323288ewuiwf87dsfhjser87sef87dsfiudsfhj"

jobs:
  include:
    - stage: run integration tests
      services:
        - docker

      script:
        - cd docker
        - ./test_integration.sh -v v17.11.12

    - stage: build docker image
      services:
        - docker

      before_script:
        - version="$TRAVIS_COMMIT"
        - docker pull "$IMAGE_NAME" || true

      script:
        - docker build --pull -f docker/Dockerfile --cache-from "$IMAGE_NAME" --tag "$IMAGE_NAME" .

      after_script:
        - echo "VERSION ${version}"
        - docker images

      before_deploy:
        - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
        - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:latest"
        - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:${version}"

      deploy:
        provider: script
        script: docker push "${IMAGE_NAME}:v17.11-latest" && docker push "${IMAGE_NAME}:v17.11-${version}"
        on:
          branch: master
